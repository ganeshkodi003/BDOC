<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org" th:fragment="header"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" type="text/css"
	href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/font-awesome/5.9.0/css/all.min.css"
	th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
	th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
	th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">


<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
	th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
	th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
<script src="/webjars/jquery/3.4.1/jquery.min.js"
	th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
	th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<script
	src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>


<link rel="stylesheet" type="text/css"
	href="webjars/chartjs/2.8.0/Chart.min.css"
	th:href="@{webjars/chartjs/2.8.0/Chart.min.css}">
<script src="webjars/chartjs/2.8.0/Chart.min.js"
	th:src="@{webjars/chartjs/2.8.0/Chart.min.js}"></script>

<link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">

<link
	href="https://fonts.googleapis.com/css?family=Nunito:400,600|Open+Sans:400,600,700"
	rel="stylesheet">
<link rel="stylesheet" href="css/spur.css">


<title>ERP</title>

<style type="text/css">
.dash-nav-item {
	min-height: 20px;
	padding: 8px 10px 8px 8px;
	letter-spacing: .01em;
}

.dash-nav-dropdown-item {
	min-height: 10px;
	padding: 8px 10px 8px 10px;
}

td {
	background-color: #f8f7ff;
}

.dash-toolbar {
	min-height: 60px;
	background-color: #FFF;
}

.dash-nav.dash-nav-dark {
	background-color: #525252;
}

.img-container {
	text-align: center;
	display: block;
	margin-left: auto;
	margin-right: auto;
	text-align: center;
	display: table-cell;
	vertical-align: middle
}

.dash-app {
	margin-left: 380px ! important;
	margin-top: 110px;
	margin-right: 110px;
}

.card-title {
	margin-bottom: 0.25rem;
}

.card-header {
	padding: 0.25rem 0.25rem;
	margin-bottom: 0;
	border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	padding: 0px;
	margin: 20dp
}

.stats-secondary {
	color: #fff;
}

.menu-title-header {
	padding: 0.45rem 0.45rem;
	background: #727F94;
	color: #fff;
	font-family: "Nunito", sans-serif;
}

.spur-card-title {
	font-family: "Nunito", sans-serif;
	font-size: 25px;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	box-sizing: border-box;
	display: inline-block;
	min-width: 1.5em;
	/* padding: 0.5em 1em; */
	margin-left: 2px;
	font-size: 15px;
	text-align: center;
	text-decoration: none !important;
	cursor: pointer;
	*cursor: hand;
	color: #d03535 !important;
	border-radius: 2px;
	height: 30px;
	text-align: center;
}

.dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate
	{
	float: center;
	font-size: 15px;
	text-align: center;
	margin-left: 10px;
}

.table.dataTable thead th, table.dataTable thead td {
	padding: 10px 10px;
	font-weight: bold;
}

thead th {
	text-align: center;
	color: black !important;
	border-bottom-width: 2px;
	font-size: medium ! important;
}
</style>
<style type="text/css">
.navbar {
    margin-left: -5px;
    position: fixed; /* Keep it fixed */
    top: 0;
    width: 100%;
    z-index: 1000; /* Ensure it's above other elements */
}
.content {
    margin-top: 151px ! important; /* Push content down to avoid overlap */
}
.container-fluid {
    width: 100%;
    padding-right: 0px;
    padding-top:1px;
    padding-left: 15px;
    margin-right: auto;
    margin-left: auto;
}
.container-manager {
	padding-right: 47px;
	padding-left: 132px;
}
.row {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin-right: -8px;
    margin-left: -22px;
}
</style>
<script type="text/javascript">
$(document).ready(function () {
    $('.dropdown, .dropdown-submenu').hover(function () {
        $(this).children('.dropdown-menu').stop(true, true).delay(200).fadeIn(200);
    }, function () {
        $(this).children('.dropdown-menu').stop(true, true).delay(200).fadeOut(200);
    });
});
</script>
</head>

<style>
.spur-card-title {
	font-family: "Nunito", sans-serif;
	font-size: 25px;
}
</style>
<script>
$(document).ready(function () {
    $('#dataTables').DataTable({
        "pageLength": 20,        // Set the number of rows per page
        "lengthChange": false,   // Hide the dropdown for changing rows per page
        "ordering": false,       // Disable column sorting
        "searching": true,       // Enable global search
        "info": true,            // Show table information
        "pagingType": "simple_numbers", // Pagination with only numbers

        // Customizing DOM structure to place search box at the top left

        "dom": '<"top"f>rt<"bottom"ip><"clear">'
    });

    // Remove the "Search:" label and add a placeholder to the search input
    $('.dataTables_filter label').contents().filter(function () {
        return this.nodeType === Node.TEXT_NODE;
    }).remove(); // Remove the text node containing "Search:"

    // Add a placeholder to the input field
    $('.dataTables_filter input')
        .attr('placeholder', 'Search...')
        .css('margin-left', '0'); // Adjust margin since the label is removed

    // Align the search box to the left corner
    $('.dataTables_filter').css({
        "float": "left",
        "text-align": "left"
    });
});



</script>
<script>
    function searchTable(tableId, searchInputId) {
    var input = $('#' + searchInputId).val().toUpperCase();
    var $table = $('#' + tableId + ' tbody');
    var rows = $table.find('tr');

    rows.each(function () {
        var cells = $(this).find('td');
        var found = false;

        cells.each(function () {
            if ($(this).text().toUpperCase().indexOf(input) > -1) {
                found = true;
                return false; // Exit loop early
            }
        });

        if (found) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Table 1
    const tableBody1 = document.getElementById('dynamicFieldsTable1').querySelector('tbody');
    
    // Function to add a new row for Table 1
    function addRowToTable1() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td style="width: 110px;"><input type="text" name="itemCode" onchange="product_name_typeFunction1(this)"
				id="itemCode" style="width: 100%;text-align:center;" list="pronameList">
				</td>
				
				<td><input type="text" name="itemname"
					id="itemname" 
					
					style="width: 100%;text-align:center;"> </td>
					
				
				
					<td><input type="text" name="category_name1" id="category_name1" style="width: 100%; text-align: center;" readonly></td>

				<td><input type="text" name="baseunit" id="baseunit" style="width: 100%;text-align:center;" ></td>
				
				<td><select name="batch" id="batch" onchange="getprice(this);" style="width: 100%;  text-align: center;"> <option>select option</option></select></td>
				
				
					
				 <td><input type="text" name="Quantity" id="Quantity" style="width: 100%;text-align:center;" ></td>
				
					<td><input type="text" name="price" id="price" style="width: 100%; text-align: center;"></td>	
					<td><select name="fgid" id="fgid" style="width: 100%;  text-align: center;"><option>select option</option></select></td>	
					<td><input type="text" name="reqqnt" id="reqqnt" oninput="calcufg();"style="width: 100%; text-align: center;"></td>		
					<td><input type="text" name="totalprice" id="totalprice" style="width: 100%; text-align: center;"></td>
					<td style="text-align: center;">
				    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
				        <span class="add-btnn" style="cursor: pointer; font-size: 20px; color: green;">
				            <i class="fas fa-plus add-btnn"></i>
				        </span>
				        <span class="remove-btnn" style="cursor: pointer; font-size: 20px; color: red;">
				            <i class="fas fa-trash remove-btnn"></i>
				        </span>
				    </div>
				</td>
					

        `;
                   // <td><button type="button"  class="btn btn-danger remove-btnn">Remove</button></td>
                   //<td style="text-align: center;"><button class="btn btn-danger btn-sm remove-btnn">-</button></td>	
        tableBody1.appendChild(newRow);
        updateSerialNumbers(tableBody1);
    }

    // Function to add a new row for Table 2
    

    // Function to update SRL No. for a table
    function updateSerialNumbers(tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.querySelector('.srl-no').textContent = index + 1; // Update SRL No.
        });
    }

    // Add event listener for the "Add" button in Table 1
    /*document.querySelector('.add-btnn').addEventListener('click', function () {
        addRowToTable1();
    });*/
    
    

    // Add event listener for the "Add" button in Table 1
  tableBody1.addEventListener('click', function (event) {
        if (event.target.classList.contains('add-btnn')) {
        	 addRowToTable1();
        }
    });

    // Add event listener for removing a row in Table 1
    tableBody1.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-btnn')) {
            event.target.closest('tr').remove();
            calcufg();
            
            
        }
    });

   

    // Initial serial number setup for existing rows in both tables
    updateSerialNumbers(tableBody1);
});




</script>

<script>
function converfg(a){
	
	 var process_id=a.getAttribute('data-process');
	 //alert(process_id);
	location.href='./TskConvertToFG?formmode=add&process_id='+process_id;
}

function product_name_typeFunction1(input) {
    const row = input.closest('tr');
   
    const productName = input.value;
  
    
    var itemsplit =productName.split('-');
    var splitfinal=itemsplit[0];

    $.ajax({
        url: "./getitemdetails1?itemCode=" + encodeURIComponent(splitfinal),
        type: 'GET',
        dataType: "json",
        success: function(response) {
        	
        	  if (response && response.length > 0) {
                  
                  var item = response[0]; 
                  
                  row.querySelector('input[name="itemname"]').value= item.itemName || '';
                  row.querySelector('input[name="category_name1"]').value= item.category || '';
                  row.querySelector('input[name="baseunit"]').value= item.unit || '';
                 
                  
                  } else {
            	  row.querySelector('input[name="itemname"]').value= '';
            	  row.querySelector('input[name="category_name1"]').value= '';
            	  row.querySelector('input[name="baseunit"]').value= '';
                  }
        	  getbatch(input);
        	  fgproduct(input);
        	  
        }
    });
}



function fgproduct(input) {
    const row = input.closest('tr');
    const baseunit = row.querySelector('input[name="baseunit"]').value;
    alert(baseunit);
    
    $.ajax({
        url: "./getitemdetailsbyunit?unit=" + encodeURIComponent(baseunit),
        type: 'GET',
        dataType: "json",
        success: function(response) {
            var selectElement = row.querySelector('select[name="fgid"]'); // Reference the select element
            selectElement.innerHTML = ''; // Clear existing options

            // Add the default option
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Select a batch';
            selectElement.appendChild(defaultOption);
            

            if (response && response.length > 0) {
                response.forEach(function(fgdata) {
                	
                	
                    // Assuming batch has itemCode and itemName properties
                    var option = document.createElement('option');
                    option.value =fgdata.itemCode + "~" +fgdata.itemName;
                    option.text = fgdata.itemCode + "~ " +fgdata.itemName; // Set the display text
                    selectElement.appendChild(option); // Append the option
                });
            } else {
                alert("No FG Product Found,Please Create FG Product");
                window.location.reload();
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX Error:", status, error);
            alert("An error occurred while fetching batch details.");
        }
    });
}

</script>

<script>
function truncateTo2Decimals(num) {
    return Math.floor(num * 100) / 100;
}

function calcufg(){
	var firstreturnunit=document.getElementById('ReturnUnit').value;
	var ReturnUnit =document.getElementById('ReturnUnit').value;
	var ReturnQuantity =document.getElementById('ReturnQuantity').value;
	var RemainingQty =ReturnQuantity;

	$('#dynamicFieldsTable1 tbody tr').each(function (index) {
	    var row = $(this);
	    ReturnUnit =document.getElementById('ReturnUnit').value;
		ReturnQuantity =document.getElementById('ReturnQuantity').value;
	    var baseunit=row.find('input[name="baseunit"]').val();
		 var splitunt=baseunit.split('-');
		 //alert(splitunt);
		 var reqqnt=Number(row.find('input[name="reqqnt"]').val());
		 var packingquanity=Number(row.find('input[name="Quantity"]').val());
		 
		 var price=Number(row.find('input[name="price"]').val());
		 var totalprice=Number(row.find('input[name="totalprice"]').val());
		 //alert(reqqnt)
		 
		 if(packingquanity<reqqnt){
			 alert("Please check Packing Material Quantity ")
			 row.find('input[name="reqqnt"]').val(0);
			 reqqnt=0; 
		 }
		 if(firstreturnunit==='kg' && splitunt[1]!='KILOGRAMS'){
			 ReturnQuantity=ReturnQuantity*0.910; 
			 ReturnUnit='ltr';
			 RemainingQty=RemainingQty*0.910;
		 }
		 
		 
		 var totalpricecal=reqqnt*price;
		 row.find('input[name="totalprice"]').val(totalpricecal.toFixed(2));
		 
		 if (ReturnUnit === 'ltr') {
			    if (splitunt[1] === 'MILILITRE') {
			        var mlCalculation = RemainingQty * 1000;
			        var requiredMl = splitunt[0] * reqqnt;
			        var total = (mlCalculation - requiredMl) / 1000;
			        

			        if (total >= 0) {
			        	if(firstreturnunit==='kg'){
			        		
			        		var convertion=total/0.910;
			        		document.getElementById('RemainingQty').value = truncateTo2Decimals(convertion).toFixed(2);
				            RemainingQty = convertion;
			        	}else{
			        		document.getElementById('RemainingQty').value = total.toFixed(2);
				            RemainingQty = total;
			        	}
			            
			        } else {
			            handleInvalidQuantity(row);
			        }
			    } else if (splitunt[1] === 'LITRES') {
			        var requiredLitres = splitunt[0] * reqqnt;
			        var totalLitres = RemainingQty - requiredLitres;

			        if (totalLitres >= 0) {
			        	
			        	
			        	if(firstreturnunit==='kg'){
			        		
			        		var convertion=totalLitres/0.910;
			        		
			        		document.getElementById('RemainingQty').value = truncateTo2Decimals(convertion).toFixed(2);
				            RemainingQty = convertion;
			        	}else{
			        		document.getElementById('RemainingQty').value = totalLitres.toFixed(2);
				            RemainingQty = total;
			        	}
			        	
			        } else {
			            handleInvalidQuantity(row);
			        }
			    }
			    else {
			    	if(reqqnt){
			    		alert("Please check item Base Unit");
			    	}
				    
				    resetInputs(row);
				}
			    
			} else if (ReturnUnit === 'ml') {
			    if (splitunt[1] === 'MILILITRE') {
			        var requiredMl = splitunt[0] * reqqnt;
			        var total = RemainingQty - requiredMl;

			        if (total >= 0) {
			            document.getElementById('RemainingQty').value = total.toFixed(2);
			            RemainingQty = total.toFixed(2);
			        } else {
			            handleInvalidQuantity(row);
			        }
			    } else if (splitunt[1] === 'LITRES') {
			        var mlCalculation = RemainingQty / 1000;
			        var requiredMl = splitunt[0] * reqqnt;
			        var total = (mlCalculation - reqqnt) * 1000;

			        if (total >= 0) {
			            document.getElementById('RemainingQty').value = total.toFixed(2);
			            RemainingQty = total;
			        } else {
			            handleInvalidQuantity(row);
			        }
			    }
			    else {
			    	if(reqqnt){
			    		alert("Please check item Base Unit");
			    	}
				    resetInputs(row);
				}
			} else if (ReturnUnit === 'kg') {
			    if (splitunt[1] === 'KILOGRAMS') {
			        var requiredKg = splitunt[0] * reqqnt;
			        var totalKg = RemainingQty - reqqnt;

			        if (totalKg >= 0) {
			            document.getElementById('RemainingQty').value = totalKg.toFixed(2);
			            RemainingQty = totalKg;
			        } else {
			            handleInvalidQuantity(row);
			        }
			    }
			    else {
			    	if(reqqnt){
			    		alert("Please check item Base Unit");
			    	}
				    resetInputs(row);
				}
			}
			else {
				if(reqqnt){
		    		alert("Please check item Base Unit");
		    	}
			    resetInputs(row);
			}
	    
	})
	
	}
	
	
function resetInputs(row) {
    row.find('input[name="itemCode"]').val("");    
    row.find('input[name="itemname"]').val("");    
    row.find('input[name="category_name1"]').val("");    
    row.find('input[name="Quantity"]').val("");    
    row.find('input[name="batch"]').val("");    
    row.find('input[name="baseunit"]').val("");    
    row.find('input[name="reqqnt"]').val("");    
}

function handleInvalidQuantity(row) {
    row.find('input[name="reqqnt"]').val(0);
    alert("Please check Return Quantity");
    calcufg();
}


function getbatch(input) {
	const row = input.closest('tr');
	   
    const productName = input.value;
  
    
    var itemsplit =productName.split('-');
    var splitfinal=itemsplit[0];
    const tableRows = document.querySelectorAll('#dynamicFieldsTable1 tbody tr');

    $.ajax({
        url: "./getbatch_price?itemCode=" + encodeURIComponent(splitfinal),
        type: 'GET',
        dataType: "json",
        success: function(response) {
        	
        	console.log("myresponseeee" +response);
        	
        	  var selectElement = row.querySelector('select[name="batch"]'); // Reference the select element
              selectElement.innerHTML = ''; // Clear existing options
              var defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.text = 'Select a batch';
              selectElement.appendChild(defaultOption);
              console.log(response.length);
        	
        	  if (response && response.length > 0) {
                  
        		  const batchSet = new Set(); 
                  
                  
                  response.forEach(function(batch) {
                	  
                	  const values = Object.values(batch);
                	  
                	  console.log(values)
                	  for (let p = 0; p < tableRows.length; p++) {
        		          const rows = tableRows[p];
        		          var batchrow = rows.querySelector('select[name="batch"]').value;
        		          var itemCoderow = rows.querySelector('input[name="itemCode"]').value;
        		          batchSet.add(batchrow); 
        		          
        		      }
                	  
                	  if(batch.batch!=null && batch.useingqty>0){
                		  if (!batchSet.has(batch.batch)) {  
			   					batchlist.push(batch); 
			                    var option = document.createElement('option');
			                    option.value = batch.batch || ''; // Set the value
			                    option.text = batch.batch || '-'; // Set the display text
			                    selectElement.appendChild(option); // Append the option
                		  }
                		}
                	  });
                  
                  console.log("patchlist" +batchlist);
                  
                 
                  } if(batchlist.length<=0){
                	  alert("Packing Material Stock Not Available")
                	  window.location.reload();
                  }
      
        }
    });
}
let batchlist =[];

function getprice(input){

	 const row = input.closest('tr');
	 
	var batch= row.querySelector('select[name="batch"]').value;
	

	 
	 batchlist.forEach(function(mufun) {
		 
	
		
		 
		 if(batch == mufun.batch){
			 
		
			 row.querySelector('input[name="price"]').value= mufun.price || '';
			 row.querySelector('input[name="Quantity"]').value= mufun.useingqty || '';
			 
			 
		 }
		 
	 });
	 
		 
}
function Sgadd(event) {

	let productLists = [];
	let validationtest=true;

	 const branchId = document.getElementById('branchId').value || "";
    const returnQuantity = document.getElementById('ReturnQuantity').value || 0;
    
    const process_id = document.getElementById('process_id').value;
    
    const returnUnit = document.getElementById('ReturnUnit').value || 0;
    const remainingQuantity = document.getElementById('RemainingQty').value || 0;
    const mfgProductName = document.getElementById('makingproductName').value || 0;
    

    // Iterate through each row in the item table to gather item data
    $('#dynamicFieldsTable1 tbody tr').each(function(index) {
        const row = $(this);

        const itemcodes = row.find('input[name="itemCode"]').val();
        const itemcodew = itemcodes.split("-");
        const itemCode=itemcodew[0];
       // alert(itemcode);
        const itemName = row.find('input[name="itemname"]').val();
        const category = row.find('input[name="category_name1"]').val();
        const baseUnit = row.find('input[name="baseunit"]').val();
        const batch = row.find('select[name="batch"]').val();
        const qty = row.find('input[name="Quantity"]').val();
        const packingmaterialprice = row.find('input[name="price"]').val()||null;
        const reqQty = row.find('input[name="reqqnt"]').val();
        
        const totalprice = row.find('input[name="totalprice"]').val();
        
        var FG_code = row.find('select[name="fgid"]').val();
        var fgcode=FG_code.split("~");
        var fg_itemcode =fgcode[0];
        var fg_name=fgcode[1];
       

        // Log row data for debugging
        console.log("Processing row " + index);
        console.log({
        	itemCode,
        	itemName,
        	category,
        	baseUnit,
        	batch,
        	qty,
        	reqQty,
        	packingmaterialprice,
        	totalprice 	
        });

        // Only push rows with complete data into productList
        if (itemCode && itemName && category && baseUnit && batch && qty && reqQty>0 && packingmaterialprice && totalprice && fg_itemcode && fg_name) {
            const listfg = {
            		branchId,
            		returnQuantity,
            		returnUnit,
            		remainingQuantity,
            		mfgProductName,
            		itemCode,
                	itemName,
                	category,
                	baseUnit,
                	batch,
                	qty,
                	reqQty,
                	packingmaterialprice,
                	totalprice,
                	fg_itemcode,
                	fg_name
                	
            };
            productLists.push(listfg);
        } else {
        	validationtest=false;
            console.warn(`Row ${index} is missing data and will be skipped.`);
        }
    });

    // Proceed only if there is data to send
    if (productLists.length > 0 & validationtest==true) {
    	console.log(productLists);
        $.ajax({
            type: 'POST',
            url: './AddConvertToFG?formmode=add&process_id='+process_id,
            contentType: 'application/json',
            data: JSON.stringify(productLists),
            success: function(response) {
            	 $("#alertmsg").text(response); // Display response in alertmsg
                 $("#alert").modal("toggle");
            	//alert(response);
				//location.href = 'ConvertToFG';
            	
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                alert("An error occurred while sending the data.");
            }
        });
    } else {
        alert("No data to send.");
    }
}

function back(event) {

	event.preventDefault();
	window.history.back();
}

function Home() {

	location.href = 'Dashboard';
}
function list(event){
	event.preventDefault();
	location.href = 'ConvertToFG';
}


</script>

    <script type="text/javascript">
    
    	function select_branch() {
    	    const branchId = document.getElementById('branchId').value;

    	    $.ajax({
    	        url: './getbranch_comp?branchId=' + branchId,
    	        type: 'GET',
    	        dataType: 'json',
    	        success: function(response) {
    	            const tableBody = document.getElementById('dataTablesBody');
    	            tableBody.innerHTML = ''; // Clear existing data

    	            if (response.length === 0) {
    	                tableBody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: red;">No records found.</td></tr>`;
    	            } else {
    	                response.forEach(process => {
    	                    // Convert numeric values safely
    	                    let requiredQty = parseFloat(process.kilograms) || 0;
    	                    let returnQty = parseFloat(process.returnquantity) || 0;
    	                    let remainingQty = parseFloat(process.useingquantity) || 0;

    	                    let row = `<tr>
    	                        <td style="text-align: center;">${process.processId}</td>
    	                        <td style="text-align: left;">${process.makingproductName}</td>
    	                        <td style="text-align: right;">${requiredQty.toFixed(3)}</td>
    	                        <td style="text-align: left;">${process.units}</td>
    	                        <td style="text-align: right;">${returnQty.toFixed(3)}</td>
    	                        <td style="text-align: right;">${remainingQty.toFixed(3)}</td>
    	                        <td style="text-align: left;">${process.returnquantityunit}</td>
    	                        <td style="text-align: left;">${formatDate(process.processStartDate)}</td>
    	                        <td style="text-align: left;">${formatDate(process.processEndDate)}</td>
    	                        <td style="text-align: center;">
    	                            <input type="radio" data-process="${process.processId}" onclick="converfg(this);">
    	                        </td>
    	                    </tr>`;
    	                    tableBody.innerHTML += row;
    	                });
    	            }
    	        },
    	        error: function(xhr, status, error) {
    	            alert("Error: " + error);
    	        }
    	    });
    	}

    	// Helper function to format date
    	function formatDate(dateString) {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';
        
        // Extract day, month, and year
        const day = String(date.getDate()).padStart(2, '0'); // Ensures two-digit format
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        const year = date.getFullYear();
        
        return `${day}-${month}-${year}`; // Format as dd-MM-yyyy
    }

    
    </script>
<body>

	<div class="container-fluid">

		<div class="row">
			<!-- sideMenu -->

			<div class="col-lg-2">
				<div th:insert="BTMHeaderMenu :: header"></div>
			</div>
			<div class="col-sm-12">
				<!-- ------history--- -->


				<div class="container-fluid content" th:if="${formmode}=='sfglist'">
					<div class="row">
						
						<form action="#" method="post" class="w-100"
							id="VendorRegistrationadd" autocomplete="off">
					<div class="card ">
					
						
						<div
									class="card-header d-flex justify-content-between align-items-center"
									style="font-family: 'Nunito', sans-serif; font-size: 1.5rem; font-weight: bold; color: black; padding-left:20px">
									<div>
										<i class="fas fa-list mr-1"></i>Semi Finished Goods - List
									</div>
												<div class="d-flex align-items-center gap-4">
            <!-- Branch Selection -->
                <select class="btn btn-light btn-sm"  onchange="select_branch();"
        style="color: black; font-weight: bold; border: 2px solid black; height: 32px;transform: translateX(-10px);"  id="branchId" name="branchId">
                    <option value="">Select Branch</option>
                    <!-- Populate options dynamically using Thymeleaf -->
                    <option th:each="branchId : ${branchIds}" th:value="${branchId}" th:text="${branchId}"></option>
                </select>
        </div>
								</div>
		
					<br>
					<!-- Table -->
					<div class="card-body">

									<div class="card-body" style="padding: 1rem;">
							
								
								<div class="table-responsive"
										style="overflow-y: auto; overflow-x: hidden; height: 85vh; border: 1px solid #dee2e6;">
							

								<div class="container-fluid">
									<div class="row">
										<div class="col-lg-12"></div>
									</div>
									<!-- Table -->

									<div class="row">
										<div class="col-lg-12">
											
												<form method="post" autocomplete="off" id="addStockHistory"
													th:fragment="finuserapply">

													<div class="card-body" style="padding: 10px;">
												<!-- 		<div class="mb-3 d-flex justify-content-between align-items-center">
											<div>
												<input type="text" id="searchInput" placeholder="Search..."
													onkeyup="searchTable('dataTables', 'searchInput')"
													class="form-control" />
											</div>
										</div> -->
														
														<table id="dataTables"
															class="table table-bordered">
															<thead>
																<tr>
																	<th style="text-align: center;">Process Id</th>
																	<th style="text-align: left;">Product Name</th>
																	<th style="text-align: right;">Required Qty</th>
																	<th style="text-align: left;">Required Unit</th>
																	<th style="text-align: right;">Return Qty</th>
																	<th style="text-align: right;">Remaining Qty</th>
																	<th style="text-align: left;">Return Unit</th>
																	<th style="text-align: left;">Starting Date</th>
																	<th style="text-align: left;">Ending Date</th>
																	<th style="text-align: center;">Action</th>
																	
																

																</tr>
															</thead>
															<tbody id="dataTablesBody">
																	<tr th:if="${#lists.isEmpty(processlist)}">
																		<td colspan="8" style="text-align: center; color: red;">No records found.</td>
																	</tr>
																<tr th:each="list : ${processlist}">
													
																	<td style="text-align: center;" th:text="${list.processId}"></td>
																	<td style="text-align: left;" th:text="${list.makingproductName}"></td>
																	<td style="text-align: right;" th:text="${#numbers.formatDecimal(list.kilograms,1,3)}"></td>
																	<td style="text-align: left;" th:text="${list.units}"></td>
																	<td style="text-align: right;" th:text="${#numbers.formatDecimal(list.returnquantity,1,3)}"></td>
																	<td style="text-align: right;" th:text="${#numbers.formatDecimal(list.useingquantity,1,3)}"></td>
																	<td style="text-align: left;" th:text="${list.returnquantityunit}"></td>
																	<td style="text-align: left;" th:text="${#dates.format(list.processStartDate,'dd-MM-yyyy')}"></td>
																	<td style="text-align: left;" th:text="${#dates.format(list.processEndDate,'dd-MM-yyyy')}"></td>
																	<td style="text-align: center;"><input type="radio" th:attr="data-process=${list.processId}" onclick="converfg(this);" ></td>
																</tr>
												
												</tbody>
														</table>
													</div>
												</form>
											</div>
										</div>
									</div>
									</div>
									<div class="card-footer text-center" style="font-family: 'Nunito', sans-serif; font-size: 23px; font-weight: 600;">
									
										<button class="btn btn-xs btn-dark" type="button" id="Dashboard" onclick="contentLoad(this)">Home</button>
										
										<button class="btn btn-xs btn-dark" type="button" id="btnBack" onclick="back(event);">Back</button>
								
								</div>
								</div>

								
								
								
								</div>
							</div>
							</form>
						</div>
						</div>
				



					<div class="container-fluid content" th:if="${formmode}=='add'">
						<div class="row">
						<!-- Form for Journal Entry -->
						<form action="#" method="post" class="w-100"
							id="VendorRegistrationadd" autocomplete="off">
									<div class="card ">
									<div class="card-header d-flex justify-content-between align-items-center" style="font-family: 'Nunito', sans-serif; font-size: 1.5rem; font-weight: bold; color: black; padding-left:20px ">
									<div>
										<i class="fas fa-sync-alt mr-2"></i>Convert To Finished Goods-<span th:text="${processwithid[0].processId}"></span>
									</div>
									<div>
										<button class="btn btn-light btn-sm"
											style="color: black; font-weight: bold; border-color: black;"
											onclick="list(event);">
											<i class="fas fa-list mr-1"></i> List
										</button>
									</div>
								</div>
					<br>
					
					<!-- Table -->
					<div class="">
						<div class="col-lg-12" style="margin-top:-15px;">
						<div class="table-responsive"
										style="overflow-y: auto; overflow-x: hidden; max-height: 85vh; border: 1px solid #dee2e6;">
						
							
							<br>
							<div class="row">
												
								 <div class="form-group col-md-auto"></div>
   									 <div class="form-group col-md-auto">
											 <label for="branchId" class="form-legend">Branch Id</label>
											 </div>
									<div class="form-group col-md-1">
										<input type="text" name="branchId" id="branchId" th:value="${processwithid[0].branchId}"
											 style="width: 100%;" readonly>	 
									</div>
												
												
								<div class="form-group col-md-auto">
									<label style="margin-left: 36px; font-weight: bolder;" for="productName">Return Quantity:</label>
								</div>
								<div class="form-group col-md-2">
    								<input type="text" name="ReturnQuantity" id="ReturnQuantity" th:value="${#numbers.formatDecimal(processwithid[0].useingquantity,1,2)}" style="width: 100%;" readonly >
									<input type="hidden" name="process_id" id="process_id" th:value="${process_id}" style="width: 100%;" readonly >
									
							
								</div>

								<div class="form-group col-md-auto">
									<label style="margin-left: 36px; font-weight: bolder;" for="productName">Return Unit:</label>
								</div>
								<div class="form-group col-md-2">
    								<input type="text" name="ReturnUnit" id="ReturnUnit" th:value="${processwithid[0].returnquantityunit}" style="width: 100%;" readonly >
								</div>
								<div class="form-group col-md-auto">
									<label style="margin-left: 36px; font-weight: bolder;" for="productName">Remaining Qty:</label>
								</div>
								<div class="form-group col-md-2">
    								<input type="text" name="RemainingQty" id="RemainingQty" style="width: 100%; margin-left:-20px" readonly >
								</div>
								


						</div>
							

								<div class="container-fluid">
									<div class="row">
										<div class="col-lg-12"></div>
									</div>
									<!-- Table -->

									<div class="row">
										<div class="col-lg-12">
											<div  style="margin-top: 40px">
													
														<table id="dynamicFieldsTable1"
															class="table table-bordered">
															<thead>
																<tr>
																	<th>Item Code</th>
																	<th>Item Name</th>
																	<!-- <th>HSN Code</th> -->
																	<th>Category</th>
																	<!-- <th>Expiry Date</th> -->
																	<th>Base Unit</th>
																	<th>Batch</th>																	
																	<th style="width: 80px;">Qty/Unit</th>
																	<th>price</th>
																	<th>Fg Name</th>
																	<th style="width: 80px;" >Req/Qty</th>
																	<th >Total Price</th>
																	<th>Action</th>

																</tr>
															</thead>
															<tbody>
																<tr>
																	
																	<td style="width: 110px;"><input type="text"
																		name="itemCode"
																		onchange="product_name_typeFunction1(this)"
																		id="itemCode"
																		style="width: 100%; text-align: center; "
																		list="pronameList"> <datalist id="pronameList">
																			<option th:each="operator : ${rawmaterial}"
																				th:value="${operator.itemCode +'-' + operator.itemName }"
																				th:text="${operator.itemCode + '-' + operator.itemName}"></option>
																		</datalist></td>

																	<td><input type="text" name="itemname"
																		id="itemname"
																		style="width: 100%; text-align: center; " readonly></td>


																	<td><input type="text" name="category_name1"
																		id="category_name1"
																		style="width: 100%; text-align: center; "
																		readonly></td>




																	<td><input type="text" name="baseunit"
																		id="baseunit"
																		style="width: 100%; text-align: center; " readonly></td>
																		
																		
																	<td><select name="batch" id="batch" onchange="getprice(this);" style="width: 100%;  text-align: center;">
																	<option>select option</option></select></td>
																	
																			
																		
																	<td><input type="text" name="Quantity"
																		id="Quantity"
																		style="width: 100%; text-align: center;" readonly></td>
																	
																		
																	<td><input type="text" name="price"
																		id="price" oninput=""
																		style="width: 100%; text-align: center;  " readonly></td>
																	
																	<td><select name="fgid" id="fgid" style="width: 100%;  text-align: center; ">
																	<option>select option</option></select></td>
																		
																		
																	<td><input type="number" name="reqqnt"
																		id="reqqnt" oninput="calcufg();"
																		style="width: 100%; text-align: center;"></td>		
																	
																	<td><input type="text" name="totalprice"
																		id="totalprice"
																		style="width: 100%; text-align: center; "readonly></td>
																	
																	
																		
																	<td style="text-align: center;">
																	    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
																	        <!-- Plus icon -->
																	        <span class="add-btnn" style="cursor: pointer; font-size: 20px; color: green;">
																	            <i class="fas fa-plus add-btnn"></i>
																	        </span>
																	        
																	        <!-- Trash (delete) icon -->
																	        <span class="remove-btnn" style="cursor: pointer; font-size: 20px; color: red;">
																	            <i class="fas fa-trash remove-btnn"></i>
																	        </span>
																	    </div>
																	</td>
																	
																			<!--<td style="text-align: center;"><button class="btn btn-danger btn-sm remove-btnn">-</button></td>-->	

																	<!--<td><button type="button"
																			class="btn btn-success add-btnn">Add</button></td>-->
																</tr>
															</tbody>
														</table>
														<!--<button style ="width:35px; margin-top:-24px"  class="btn btn-primary add-btnn"id="addRowBtn">+</button>
														<div></div>
														<br>-->
														
														


														<div class="form-row align-items-center ml-1" >
															<div class="form-group col-md-2">
																<label for="productName">Mfg Product Name:</label>
															</div>
															<div class="form-group col-md-2">
																<input type="text" class="form-control" th:value="${processwithid[0].makingproductName}"
																	id="makingproductName" placeholder="Enter product name"
																	style="border-color: #333333; " readonly
																	required>
															</div>
															
															<div class="form-group col-md-2"></div>
															
															
														</div>
														
													


													</div>
												</form>
											</div>
										</div>
									</div>


								</div>
								</div>
								<br>
								
								<div 	class="card-footer text-center"
									style="font-family: 'Nunito', sans-serif; font-size: 23px; font-weight: 600;">
									
										<button class="btn btn-xs btn-dark"
											
											type="button" id="Dashboard" onclick="contentLoad(this)">Home</button>
										<button class="btn btn-xs btn-dark" id="btnSubmit"
											
											onclick="Sgadd(event);">Submit</button>
										<button class="btn btn-xs btn-dark"
											
											type="button" id="btnBack" onclick="back(event);">Back</button>
								
								</div>
								
								
								
						

							</div>
						</div>
					</div>
				</div>



				
								

							</div>
						</div>
		<div class=" modal fade" id="alert">
		<div
			class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="menu-title-header">
					<div class="modal-title" id="exampleModalLabel"
						style="text-align: center; color: rgb(0, 0, 0);">ERP</div>
				</div>
				<div class="modal-body"
					style="text-align: center; background-color: #c6ccd2">
					<p id="alertmsg"></p>
					<button type="button" class="btn btn-primary" data-dismiss="modal"
						onclick="window.location.href='tskConvertToFG';">Close</button>
				</div>
			</div>
		</div>
	</div>		
						
</body>

</html>