<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org" th:fragment="header"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" type="text/css"
	href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/font-awesome/5.9.0/css/all.min.css"
	th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
	th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">
<link rel="stylesheet" type="text/css"
	href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
	th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">


<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
	th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
	th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
<script src="/webjars/jquery/3.4.1/jquery.min.js"
	th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
	th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
<script
	src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
	th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>


<link rel="stylesheet" type="text/css"
	href="webjars/chartjs/2.8.0/Chart.min.css"
	th:href="@{webjars/chartjs/2.8.0/Chart.min.css}">
<script src="webjars/chartjs/2.8.0/Chart.min.js"
	th:src="@{webjars/chartjs/2.8.0/Chart.min.js}"></script>

<link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">

<link
	href="https://fonts.googleapis.com/css?family=Nunito:400,600|Open+Sans:400,600,700"
	rel="stylesheet">
<link rel="stylesheet" href="css/spur.css">


<title>ERP</title>

<style type="text/css">
.dash-nav-item {
	min-height: 20px;
	padding: 8px 10px 8px 8px;
	letter-spacing: .01em;
}

.dash-nav-dropdown-item {
	min-height: 10px;
	padding: 8px 10px 8px 10px;
}

td {
	background-color: #f8f7ff;
}

.dash-toolbar {
	min-height: 60px;
	background-color: #FFF;
}

.dash-nav.dash-nav-dark {
	background-color: #525252;
}

.img-container {
	text-align: center;
	display: block;
	margin-left: auto;
	margin-right: auto;
	text-align: center;
	display: table-cell;
	vertical-align: middle
}

.dash-app {
	margin-left: 380px ! important;
	margin-top: 110px;
	margin-right: 110px;
}

.card-title {
	margin-bottom: 0.25rem;
}

.card-header {
	padding: 0.25rem 0.25rem;
	margin-bottom: 0;
	border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	padding: 0px;
	margin: 20dp
}

.stats-secondary {
	color: #fff;
}

.menu-title-header {
	padding: 0.45rem 0.45rem;
	background: #727F94;
	color: #fff;
	font-family: "Nunito", sans-serif;
}

.spur-card-title {
	font-family: "Nunito", sans-serif;
	font-size: 25px;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	box-sizing: border-box;
	display: inline-block;
	min-width: 1.5em;
	/* padding: 0.5em 1em; */
	margin-left: 2px;
	font-size: 15px;
	text-align: center;
	text-decoration: none !important;
	cursor: pointer;
	*cursor: hand;
	color: #d03535 !important;
	border-radius: 2px;
	height: 30px;
	text-align: center;
}

.dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate
	{
	float: none;
	font-size: 15px;
	text-align: center;
	margin-left: 10px;
}

.table.dataTable thead th, table.dataTable thead td {
	padding: 10px 10px;
	font-weight: bold;
}

thead th {
	text-align: center;
	color: black !important;
	border-bottom-width: 2px;
	font-size: medium ! important;
}
</style>
</head>


<script th:inline="javascript">
	$(function() {

		$("#dataTables").DataTable({
			"destroy" : true,
			"scrollY" : 400,
			"scrollCollapse" : true,
			"paging" : true,
			"autoWidth" : false,
			"ordering" : false,
			"searching" : false,
			"scrollX" : true,
			"pageLength" : 100,
			"lengthChange" : false,

		});
	});
	$(document).ready(function() {

		$("#Upload").on("click", function() {

			$.ajax({
				url : './fileimport',
				type : 'POST',
				data : new FormData($("#fileuploadd")[0]),
				enctype : 'multipart/form-data',
				processData : false,
				contentType : false,
				success : function(res) {
					window.alert(res);
					//location.href = './stockHistory'

				}
			});
			e.preventDefault();

		});
	});
	
	var checkff=true;

	function checkFields(){
		var fields = $('input.required');
		for (var i = 0; i < fields.length; i++) {
			if ($(fields[i]).val() != '') {
				window.alert("Enter all required fields");
				checkff=true;
			}else{
				checkff=false;
			}
		}
		
	}
	function singleStockHistory() {
		
		alert("Added Successfully!!!")



	};

	function singleStockCurrent() {
		const inputs = document.querySelectorAll('#addStockHistory input');
		for (var i = 0; i < inputs.length; i++) {
			if ($(inputs[i]).val() == '') {
				alert("Enter all required fields");
				break;
			}
		}
		if ($(inputs[i]).val() != '') {
		var expdate = document.getElementById('EXPIRY_DATEs').value;
		$.ajax({
			url : "./singleStockCurrent?expdate=" + expdate,
			dataType : "text",
			type : 'POST',
			aync : true,
			data : $('#addStockHistory').serialize(),
			success : function(res) {

				alert(res);
				location.href = './stockHistory'

			}
		});
		};
	};

	function product_name_typeFunction1(input) {
	    const row = input.closest('tr');
	    const productName = input.value;
	    const batchSelect = row.querySelector('select[name="batch[]"]');
	    const categoryNameInput = row.querySelector('input[name="category_name1[]"]');

	    $.ajax({
	        url: "./getStocksss?product_id=" + encodeURIComponent(productName),
	        type: 'GET',
	        dataType: "json",
	        success: function(res) {
	        	
	            let options = '<option>SELECT</option>';
	            $.each(res, function(index, data) {
	                const values = Object.values(data);
	                categoryNameInput.value = values[1]; // Update category name
	                options += `<option value="${values[0]}">${values[0]}</option>`;
	            });

	            // Update the batch select field in the current row
	            batchSelect.innerHTML = options;

	            // Remove duplicate options if any
	            const uniqueOptions = [];
	            batchSelect.querySelectorAll('option').forEach(option => {
	                if (uniqueOptions.includes(option.value)) {
	                    option.remove();
	                } else {
	                    uniqueOptions.push(option.value);
	                }
	            });
	        }
	    });
	}

	function getPatientlist(mode, num, maxpage) {

		var n = parseInt(num);
		var max = parseInt(maxpage);

		///alert(n+"  "+max);
		var Callurl = 'Dashboard?formmode=list';

		switch (mode) {
		case "nextpage":
			n = n + 1;
			if (n > max) {
				break;
			}
			Callurl = Callurl + "&page=" + n;
			break;
		case "prevpage":
			n = n - 1;
			if (n < 0) {
				break;
			}
			Callurl = Callurl + "&page=" + n;
			break;
		case "givenpage":
			n = parseInt($("#pageno").val()) - 1;
			if (n > max || n < 0) {
				break;
			}
			Callurl = Callurl + "&page=" + n;
		}

		//alert(Callurl);
		location.href = Callurl;
	}

	function back() {
		window.history.back();
	}
	function finaltotal(total){
		alert(total)

	}
	
	function totalcal(selectElement){
		const row = selectElement.closest('tr');
		const cost = row.querySelector('input[name="cost[]"]').value;
		const qnt = row.querySelector('input[name="KGS[]"]').value;
		const total = row.querySelector('input[name="total[]"]');
		total.value=qnt*cost;
		 finaltotal(total.value)

	}
	
	function getcurrentstock(selectElement) {
	    // Find the closest row (tr) to the changed select element
	    const row = selectElement.closest('tr');

	    // Get the product name from the input field in the same row
	    const pro_name = row.querySelector('input[name="product_name[]"]').value;

	    // Fetch the selected batch value
	    const batch = selectElement.value;

	    // Proceed with the AJAX requests
	    $.ajax({
	        url: "./getpkgtypeList?product_id=" + pro_name + "&batch=" + batch,
	        type: 'GET',
	        dataType: "json",
	        success: function(res) {
	            $.each(res, function(index, data) {
	                var i = Object.values(data);
	                // Update the corresponding fields in the same row
	                row.querySelector('input[name="EXPIRY_DATEs[]"]').value = i[1];
	                // Update other fields as needed using similar methods
	            });
	        }
	    });

	    $.ajax({
	        url: "./getCurrentStockfn?product_id=" + pro_name + "&batch=" + batch,
	        type: 'GET',
	        dataType: "json",
	        success: function(res) {
	            $.each(res, function(index, data) {
	                var i = Object.values(data);
	                // Update the corresponding fields in the same row
	                //row.querySelector('input[name="PKG[]"]').value = i[0];
	                row.querySelector('input[name="UNITS[]"]').value = 10;
	                row.querySelector('input[name="cost[]"]').value = i[3];
	                row.querySelector('input[name="GSTIN[]"]').value = i[4];
	                row.querySelector('input[name="MRP[]"]').value = i[2];
	            });
	        }
	    });
	}

	
	document.addEventListener('DOMContentLoaded', function() {
	    const table = document.getElementById('dynamicFieldsTable').querySelector('tbody');

	    // Function to add a new row
	    function addRow() {
	        const newRow = document.createElement('tr');
	        newRow.innerHTML = `
	            <td>
	                <input type="text" name="product_name[]" list="pronameList" onchange="product_name_typeFunction1(this)" style="width: 100%;">
	                <datalist id="pronameList">
	                    <option th:each="operator : \${productList}" th:value="\${operator.PRODUCT_NAME}" th:text="\${operator.PRODUCT_NAME}"></option>
	                </datalist>
	            </td>
	            <td><select id="BATCH" name="batch[]" onchange="getcurrentstock(this)" style="width: 100%;">
                <option>SELECT</option>
	            </select></td>
	            <td><input type="text" name="UNITS[]" style="width: 100%;"></td>
	            <td><input type="text" name="category_name1[]" style="width: 100%;"></td>
	            <td><input type="text" name="PKG[]" style="width: 100%;"></td>
	            <td><input type="text" name="qty[]" style="width: 100%;"></td>
	            <td><button type="button" class="btn btn-danger remove-btn">Remove</button></td>
	        `;
	        table.appendChild(newRow);
	    }

	    // Add event listener for the "Add" button
	    document.querySelector('.add-btn').addEventListener('click', function() {
	        addRow();
	    });

	    // Add event listener for removing a row
	    table.addEventListener('click', function(event) {
	        if (event.target.classList.contains('remove-btn')) {
	            event.target.closest('tr').remove();
	        }
	    });
	});



</script>

<script type="text/javascript">
/* function addTaxData(event) {
    event.preventDefault(); // Prevent the default form submission

    var productlist = [];
    var makename = document.getElementById('makingproductName').value;
    //alert(makename); 
    $('#dynamicFieldsTable tbody tr').each(function(index) {
        var row = $(this);
        console.log("Processing row " + index);
        console.log(row.html());  // Log the HTML of the current row to check its structure

        var productName = row.find('input[name="product_name[]"]').val();
        var batchs = row.find('select[name="batch[]"]').val();
        var gstin = row.find('input[name="GSTIN[]"]').val();
        var expdate = row.find('input[name="EXPIRY_DATEs[]"]').val();
        var mrp = row.find('input[name="MRP[]"]').val();
        var units = row.find('input[name="UNITS[]"]').val();
        var categoryName = row.find('input[name="category_name1[]"]').val();
        var pkg = row.find('input[name="PKG[]"]').val();
        console.log({
            productName: productName,
            batch: batchs,
            gstin: gstin,
            expdate: expdate,
            mrp: mrp,
            units: units,
            categoryName: categoryName,
            pkg: pkg
        });

        if (productName && batchs && gstin && expdate && mrp && units && categoryName && pkg && makename) {
            var lists = {
                pname: productName,
                batch: batchs,
                gstin: gstin,
                expdate: expdate,
                mrp: mrp,
                unitinkg: units,
                catname: categoryName,
                pkgs: pkg,
                make_product_name:makename
            };
            productlist.push(lists);
        } else {
            console.warn("Row " + index + " is missing data and will be skipped.");
        }
    });

    if (productlist.length > 0) {
        $.ajax({
            type: 'POST',
            url: './add_processes?formmode=add',
            contentType: 'application/json',
            data: JSON.stringify(productlist),
            success: function(response) {
                alert(response);
                 window.location.reload();
                // $("#alertmsg").text(response);
                // $('#alert').modal("toggle");
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                alert("An error occurred while sending the data.");
            }
        });
    } else {
        alert("No data to send.");
    }
} */
</script>
<style>
.spur-card-title {
	font-family: "Nunito", sans-serif;
	font-size: 25px;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Table 1
    const tableBody1 = document.getElementById('dynamicFieldsTable1').querySelector('tbody');
    // Table 2
    const tableBody2 = document.getElementById('dynamicFieldsTableex').querySelector('tbody');

    // Function to add a new row for Table 1
    function addRowToTable1() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="srl-no"></td> <!-- SRL No. will be updated -->
            <td>
                <input type="text" name="product_name[]" list="pronameList" onchange="product_name_typeFunction1(this)" style="width: 100%;">
                <datalist id="pronameList">
                    <option th:each="operator : \${productList}" th:value="\${operator.PRODUCT_NAME}" th:text="\${operator.PRODUCT_NAME}"></option>
                </datalist>
            </td>
            <td><select id="BATCH" name="batch[]" onchange="getcurrentstock(this)" style="width: 100%;"><option>SELECT</option></select></td>
            <td><input type="text" name="category_name1[]" style="width: 100%;" readonly></td>
            <td><input type="text" name="EXPIRY_DATEs[]" style="width: 100%;" readonly></td>
            <td><input type="text" name="UNITS[]" style="width: 100%;" readonly></td>
            <td><input type="text" name="cost[]" id="cost" style="width: 100%;" readonly></td>
            <td><input type="text" name="KGS[]" oninput="totalcal(this)"style="width: 100%;"></td>
            <td><input type="text" name="total[]" id="total" style="width: 100%;" readonly></td>
            
            <td><button type="button" class="btn btn-danger remove-btnn">Remove</button></td>
        `;
        tableBody1.appendChild(newRow);
        updateSerialNumbers(tableBody1);
    }

    // Function to add a new row for Table 2
    function addRowToTable2() {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="srl-no"></td> <!-- SRL No. will be updated -->
            <td>
                <input type="text" name="ExpensesType[]" id="ExpensesType" list="Expenseslist" style="width: 100%;">
                <datalist id="Expenseslist">
                    <option>Labour cost</option>
                    <option>Machinery cost</option>
                    <option>Electricity cost</option>
                    <option>Overhead cost</option>
                </datalist>
            </td>
            <td><input type="text" name="per/Amount[]" id="per/Amount" style="width: 100%;"></td>
            <td><button type="button" class="btn btn-danger remove-btnn">Remove</button></td>
        `;
        tableBody2.appendChild(newRow);
        updateSerialNumbers(tableBody2);
    }

    // Function to update SRL No. for a table
    function updateSerialNumbers(tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.querySelector('.srl-no').textContent = index + 1; // Update SRL No.
        });
    }

    // Add event listener for the "Add" button in Table 1
    document.querySelector('.add-btnn').addEventListener('click', function () {
        addRowToTable1();
    });

    // Add event listener for the "Add" button in Table 2
    tableBody2.addEventListener('click', function (event) {
        if (event.target.classList.contains('btn-success')) {
            addRowToTable2();
        }
    });

    // Add event listener for removing a row in Table 1
    tableBody1.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-btnn')) {
            event.target.closest('tr').remove();
            updateSerialNumbers(tableBody1); // Update SRL No. after removing a row
        }
    });

    // Add event listener for removing a row in Table 2
    tableBody2.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-btnn')) {
            event.target.closest('tr').remove();
            updateSerialNumbers(tableBody2); // Update SRL No. after removing a row
        }
    });

    // Initial serial number setup for existing rows in both tables
    updateSerialNumbers(tableBody1);
    updateSerialNumbers(tableBody2);
});




</script>



<script type="text/javascript">

function dr(event){
	event.preventDefault();
	}

function addnewproduct(event) {
    event.preventDefault(); // Prevent default form submission

    var productlist = [];
    var makename = document.getElementById('makingproductName').value; // Get the manufacturing product name

    // Ensure the make name is not empty
    if (!makename) {
        alert("Please enter the Manufacturing Product Name.");
        return;
    }

    // Loop through each row in the dynamic table
    $('#dynamicFieldsTable1 tbody tr').each(function(index) {
        var row = $(this);

        var productNamee = row.find('input[name="product_name[]"]').val();
        var batchs = row.find('select[name="batch[]"]').val();
        var expdatee = row.find('input[name="EXPIRY_DATEs[]"]').val();
        var unitss = row.find('input[name="UNITS[]"]').val();
        var categoryNamee = row.find('input[name="category_name1[]"]').val();
        var kgss = row.find('input[name="KGS[]"]').val();
        var total=row.find('input[name="total[]"]').val();
        var Mrp=row.find('input[name="cost[]"]').val();
        
        console.log({
            pname: productNamee,
            batch: batchs,
            expdate: expdatee,
            unitinkg: unitss,
            catname: categoryNamee,
            kgs: kgss,
            make_product_name: makename
        });
        
        
        $('#dynamicFieldsTableex tbody tr').each(function (index) {
    	    var row = $(this);

    	    var expensesType = row.find('input[name="ExpensesType[]"]').val();
    	    var amount = row.find('input[name="per/Amount[]"]').val();
			var list1={
					makeProductName: makename,
	    	        expensesType: expensesType,
	    	        expensesamount: amount
			}
			
			productlist.push(list1);
    	    console.log({
    	    	makeProductName: makename,
    	        expensesType: expensesType,
    	        amount: amount,
    	    });
    	    
    	});

        
        

        // Ensure all fields are filled before adding the product to the list
        if (productNamee && batchs && expdatee && unitss && categoryNamee && kgss && total &&Mrp) {
            var lists = {
            	productName: productNamee,
                batch: batchs,
                expiryDate: expdatee,
                unitInKg: unitss,
                categoryName: categoryNamee,
                kgs: kgss,
                makeProductName: makename,
                expensesamount:total,
                mrp:Mrp
            };
            productlist.push(lists);
        } else {
            console.warn("Row " + (index + 1) + " is missing data and will be skipped.");
        }
    });

    // If product list is not empty, send the data via AJAX
    if (productlist.length > 0) {
    	
    	console.log(productlist);
        $.ajax({
            type: 'POST',
            url: './add_new_product?formmode=add',
            contentType: 'application/json',
            data: JSON.stringify(productlist),
            success: function(response) {
                alert(response); // Notify success
                window.location.reload(); // Reload the page to reflect changes
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                alert("Product name already Exists or An error occurred while sending the data");
            }
        });
    } else {
        alert("No valid data to send. Please fill out the form correctly.");
    }
}
</script>
<script>
function deleteProduct(a) {
    var makeproductname = a.getAttribute('data-makename'); // Get the data-id attribute value
    alert(makeproductname); // Optional: Show the ID for debugging

    $.ajax({
        type: 'POST',
        url: './delete_product?makeproductname=' + makeproductname, // Pass the product ID to the delete URL
        contentType: 'application/json',
        success: function(response) {
            alert(response); // Notify success
            window.location.reload(); // Reload the page to reflect changes
        },
        error: function(xhr, status, error) {
            console.error("AJAX error:", status, error);
            alert("An error occurred while deleting the product. Please try again.");
        }
    });
}


</script>
<script>

function makelist_fn(){
	 var makesname = document.getElementById("makesname").value; 
	 //alert(makesname)
	    $.ajax({
	        url: "./getmakeproduct?makesname=" + encodeURIComponent(makesname),
	        type: 'GET',
	        dataType: "json",
	        success: function(res) {
	        	const table = document.getElementById('dynamicFieldsTable').querySelector('tbody');
	        	const table1 = document.getElementById('dynamicFieldsTableex').querySelector('tbody');
	            // Clear the table before adding new rows
	            table.innerHTML = '';
	            table1.innerHTML='';

	            // Loop through the response to add rows dynamically
	            $.each(res, function(index, data) {
	                const values = Object.values(data);

	                // Create a new row
	                
	                //alert(values[0]);
	                if (values[0]!=null){
	                const newRow = document.createElement('tr');
	                newRow.innerHTML = `
	                    <td>
	                        <input type="text" name="product_name[]" value="${values[0]}" list="pronameList" onchange="product_name_typeFunction1(this)" style="width: 100%;">
	                        <datalist id="pronameList">
	                            <option th:each="operator : \${productList}" th:value="\${operator.PRODUCT_NAME}" th:text="\${operator.PRODUCT_NAME}"></option>
	                        </datalist>
	                    </td>
	                    <td>
	                        <select id="BATCH" name="batch[]" onchange="getcurrentstock(this)" style="width: 100%;">
	                            <option value="${values[1]}">${values[1]}</option>
	                        </select>
	                    </td>
	                    <td>
	                        <input type="text" name="UNITS[]" value="${values[2]}" style="width: 100%;" readonly>
	                    </td>
	                    <td>
	                        <input type="text" name="category_name1[]" value="${values[3]}" style="width: 100%;">
	                    </td>
	                    <td>
	                        <input type="text" name="PKG[]" value="${values[4]}" style="width: 100%;" readonly>
	                    </td>
	                    <td>
	                        <input type="text" name="qty[]" value="" style="width: 100%;">
	                    </td>
	                    <td>
	                        <button type="button" class="btn btn-danger remove-btn">Remove</button>
	                    </td>
	                `;
	                
	                // Append the new row to the table
	                var batch =newRow.querySelector('[name="batch[]"]');
	                getcurrentstock(batch);
	                table.appendChild(newRow);
	                }
	                else{
	                	const newRow = document.createElement('tr');
	                	newRow.innerHTML =`	
	                	<td>
	                    <input type="text" name="ExpensesType[]" id="ExpensesType" value="${values[6]}" style="width: 100%;">
	                    
	                </td>
	                <td><input type="text" name="per/Amount[]" id="per/Amount" value="${values[7]}" style="width: 100%;"></td>
	                <td style="text-align:center"><button type="button"  class="btn btn-danger remove-btnn" >Remove</button></td>`;
	                table1.appendChild(newRow)
	                }
	                
	                

	        		 document.getElementById('makingproductName').value=values[5];
	            });

	        }
	    });
	
}



</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener after the DOM has fully loaded
    document.getElementById('kilograms').addEventListener('input', function ()  {
        //alert('Input event triggered'); // This alert should show when typing in the "kilograms" field
        
        // Get the entered value in the kilograms input
        var orderKgs = parseFloat(this.value);


        // Check if a valid number is entered
        if (isNaN(orderKgs)) {
            return; // Exit if no valid number
        }

        // Get all rows in the table
        var tableRows = document.querySelectorAll('#dynamicFieldsTable tbody tr');

        tableRows.forEach(function(row) {
            // Get the "kgs" value for each row using the name attribute selector
            var kgsValue = parseFloat(row.querySelector('[name="PKG[]"]').value);
            var unit =parseFloat(row.querySelector('[name="UNITS[]"]').value);
            var product_name =row.querySelector('[name="product_name[]"]').value;
            // If the kgsValue is a valid number, multiply it with the orderKgs and update the quantity field
            if (!isNaN(kgsValue)) {
                var calculatedQty = orderKgs * kgsValue;
                if(calculatedQty>unit){
                	alert("please check current stock of "+product_name);
                	row.querySelector('[name="qty[]"]').value ="";
                	
                }
                else{
                // Set the value of the quantity field in the same row
                row.querySelector('[name="qty[]"]').value = calculatedQty.toFixed(2); // Fixed to 2 decimal places
                }
                }
        });
    });
});

function n(){
	var orderNos = document.getElementById('kilograms').value;
	var tableRows = document.querySelectorAll('#dynamicFieldsTable tbody tr');

    tableRows.forEach(function(row) {
        // Get the "kgs" value for each row using the name attribute selector
        var kgsValue = parseFloat(row.querySelector('[name="PKG[]"]').value);
        var unit =parseFloat(row.querySelector('[name="UNITS[]"]').value);
        var product_name =row.querySelector('[name="product_name[]"]').value;
        //alert(product_name);

        // If the kgsValue is a valid number, multiply it with the orderKgs and update the quantity field
        if (!isNaN(kgsValue)) {
            var calculatedQty = orderNos * kgsValue;
            if(calculatedQtyunit){
            	alert("please check current stock of "+product_name);
            }
            else{

            // Set the value of the quantity field in the same row
            row.querySelector('[name="qty[]"]').value = calculatedQty.toFixed(2); // Fixed to 2 decimal places
            }
        }
        
    });

	
}

</script>

<script type="text/javascript">

function addTaxData(event) {
    event.preventDefault(); // Prevent the default form submission

    var productlist = [];
    var makename = document.getElementById('makingproductName').value;
    var orderNos = document.getElementById('kilograms').value;
    var woid = document.getElementById('woid').value;
    //alert(makename); 
    //alert(orderNos); 
    $('#dynamicFieldsTable tbody tr').each(function(index) {
        var row = $(this);
        console.log("Processing row " + index);
        console.log(row.html());  // Log the HTML of the current row to check its structure

        var productName = row.find('input[name="product_name[]"]').val();
        var batchs = row.find('select[name="batch[]"]').val();
        var units = row.find('input[name="UNITS[]"]').val();
        var categoryName = row.find('input[name="category_name1[]"]').val();
        var pkg = row.find('input[name="PKG[]"]').val();
        var quantity = row.find('input[name="qty[]"]').val();
        console.log({
            productName: productName,
            batch: batchs,
            units: units,
            categoryName: categoryName,
            pkg: pkg,
            qty:quantity
        });

        if (productName && batchs && units && categoryName && pkg && makename && orderNos && quantity) {
            var lists = {
                pname: productName,
                batch: batchs,
                unitinkg: units,
                catname: categoryName,
                pkgs: pkg,
                qty: quantity,
                kilograms: orderNos,
                make_product_name:makename
            };
            productlist.push(lists);
        } else {
            console.warn("Row " + index + " is missing data and will be skipped.");
        }
    });

    if (productlist.length > 0) {
        $.ajax({
            type: 'POST',
            url: './add_processes?formmode=add&woid='+woid,
            contentType: 'application/json',
            data: JSON.stringify(productlist),
            success: function(response) {
                alert(response);
                 window.location.reload();
                // $("#alertmsg").text(response);
                // $('#alert').modal("toggle");
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                alert("An error occurred while sending the data.");
            }
        });
    } else {
        alert("No data to send.");
    }
}
//Function to read the options from the 'makelist' datalist
function readMakelistOptions() {
    const datalist = document.getElementById('makelist'); // Get the datalist element
    const options = datalist.querySelectorAll('option');// Get all options inside the datalist
    const woid =document.getElementById('woid').value;
    const makesname =document.getElementById('makesname');
    const kilograms=document.getElementById('kilograms');
    
    //alert(woid);
 // Create an array to store the option values
    const makelistValues = [];
    var makename="";
    $.ajax({
        type: 'GET',
        url: './getWO?woid='+woid,
        success: function(response) {
            //alert(response.item);
            options.forEach(option => {
                makelistValues.push(option.value);// You can also use option.text if you want the text
                if(response.item==option.value){
                	makename=option.value;
                	//alert(makename);	
                }   
            });
            if (makename!=""){
            makesname.value=makename;
        	makelist_fn();
        	kilograms.value=response.qty;
        	setTimeout(n,3000);
            }
            else{
            	alert("please Add New product");
            	location.reload();
            }
           
        },
        error: function(xhr, status, error) {
            console.error("AJAX error:", status, error);
            alert("An error occurred while sending the data.");
        }
    });
    
        
    // Loop through the options and add their values to the array
    
    
    console.log(makelistValues); // Output the array to the console or process further
}

function totalcl(){
	var peramount=document.getElementById('per/Amount').value;
	var qnt=document.getElementById('Quantity').value;
	var qnt=document.getElementById('TotalAmount');
	alert(peramount);
}

</script>
<body>

	<div class="container-fluid">

		<div class="row">
			<!-- sideMenu -->

			<div class="col-lg-2">
				<div th:insert="BTMHeaderMenu :: header"></div>
			</div>

			<div class="dash-app" th:if="${formmode}=='add'">
				<div class="spur-card-title"
					style="font-size: 25px; background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; border-bottom: 1px solid #17a2b852;">
					<div class="spur-card-title">
						Add - New Product
						<div class="float-right">
							<button class="btn btn-primary"
								onclick="location.href='./process?';">History</button>
						</div>
					</div>
				</div>
				<br>
				<!-- Table -->
				<div class="row">
					<div class="col-lg-12">
						<div class="card ">

							<div class="container-fluid">
								<div class="row">
									<div class="col-lg-12"></div>
								</div>
								<!-- Table -->

								<div class="row">
									<div class="col-lg-12">
										<div class="card " style="margin-top: 40px">
											<form method="post" autocomplete="off" id="addStockHistory"
												th:fragment="finuserapply">

												<div class="card-body" style="padding: 10px;">
													<table id="dynamicFieldsTable1"
														class="table table-bordered">
														<thead>
															<tr>
																<th>SRL No.</th>
																<th>Product Name</th>
																<th>Batch</th>
																<th>Category Name</th>
																<th>Expiry Date</th>
																<th>Units in Kgs</th>
																<th>Cost</th>
																<th>Kgs</th>
																<th>Total</th>
																<th>Actions</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td class="srl-no">1</td>
																<td><input type="text" name="product_name[]"
																	id="product_name1" list="pronameList"
																	onchange="product_name_typeFunction1(this)"
																	style="width: 100%;"> <datalist
																		id="pronameList">
																		<option th:each="operator : ${productList}"
																			th:value="${operator.PRODUCT_NAME}"
																			th:text="${operator.PRODUCT_NAME}"></option>
																	</datalist></td>
																<td style="width: 110px;"><select id="BATCH"
																	onchange="getcurrentstock(this)" name="batch[]"
																	style="width: 100%;">
																		<option>SELECT</option>
																</select></td>
																
																<td><input type="text" name="category_name1[]"
																	id="category_name1" style="width: 100%;" readonly></td>

																<td><input type="text" name="EXPIRY_DATEs[]"
																	id="EXPIRY_DATEs" style="width: 100%;" readonly></td>
																	
																	
																<td><input type="text" name="UNITS[]" id="UNITS"
																	style="width: 100%;" readonly></td>
																	
																<td><input type="text" name="cost[]" id="cost"
																	style="width: 100%;" readonly></td>	
																	
																<td><input type="text" name="KGS[]" oninput="totalcal(this)" id="KGS"
																	style="width: 100%;"></td>
																	
																<td><input type="text" name="total[]" id="total"
																	style="width: 100%;" readonly></td>
																	
																<td><button type="button"
																		class="btn btn-success add-btnn">Add</button></td>
															</tr>
														</tbody>
													</table>
													
									<div class="card-header"
									style="font-family: 'Nunito', sans-serif; font-size: 23px; font-weight: 600; padding:1.7rem;">

									<div class="float-left">
										<h6 style="font-size: 1.5rem; color: black;">Other Expenses</h6>
									</div>
									

								</div>
													
													
													
													<table id="dynamicFieldsTableex"
														class="table table-bordered">
														<thead>
															<tr>
																<th>SRL No.</th>
																<th>Expenses Type</th>
																<th>Expenses cost</th>
																<th>Actions</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td class="srl-no">1</td>
																<td><input type="text" name="ExpensesType[]"
																	id="ExpensesType" list="Expenseslist"
																	style="width: 100%;"> <datalist
																		id="Expenseslist">
																		<option>Labour cost</option>
																		<option>Machinary cost</option>
																		<option>Electricity cost</option>
																		<option>Overhead cost</option>
																	</datalist></td>
																

																<td><input type="text" name="per/Amount[]"
																	id="per/Amount" style="width: 100%;" ></td>

																<td><button type="button"
																		class="btn btn-success add-btnn">Add</button></td>
															</tr>
														</tbody>
													</table>
													
													
													
													<div class="form-row align-items-center">
														<div class="form-group col-md-2">
															<label for="productName">Mfg Product Name:</label>
														</div>
														<div class="form-group col-md-2">
															<input type="text" class="form-control"
																id="makingproductName" placeholder="Enter product name"
																style="border-color: #333333;" required>
														</div>
														<div class="form-group col-md-2"></div>
														<div class="form-group col-md-1">
															<button class="btn btn-primary" id="btnSubmit"
																style="background-color: #007bff"
																onclick="addnewproduct(event);">New</button>
														</div>
													</div>
																										

												</div>
											</form>
										</div>
									</div>
								</div>


							</div>
							<br>
							<div class="col-lg-12  "
								style="font-size: 25px; background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; height: 50px; border-bottom: 1px solid #17a2b852;">
								<div>Product List</div>
							</div>
							<div class="card-body">
								<table class="table table-striped " id="dataTables">
									<thead class="stats-secondary">
										<tr>
											<th style="text-align: center; font-size: 15px">ID</th>
											<th style="text-align: center; font-size: 15px">Make
												Product</th>
											<th style="text-align: center; font-size: 15px">Use
												Product</th>
											<th style="text-align: center; font-size: 15px">Batch</th>
											<th style="text-align: center; font-size: 15px">Expiry
												Date</th>
											<th style="text-align: center; font-size: 15px">Category</th>
											<th style="text-align: center; font-size: 15px">Kgs</th>
											<th style="text-align: center; font-size: 15px">Delete</th>

										</tr>
									</thead>
									<tbody>
										<tr th:each="listItem : ${stockLists}" class="userlist">
											<td style="text-align: center; width: 50px"
												th:text="${listItem[0]}"></td>
											<td style="text-align: center; width: 100px"
												th:text="${listItem[10]}"></td>
											<td style="text-align: center; width: 150px"
												th:text="${listItem[1]}"></td>
											<td style="text-align: center; width: 50px"
												th:text="${listItem[2]}"></td>
											<td style="text-align: center; width: 100px"
												th:text="${listItem[4]}"></td>
											<td style="text-align: center; width: 100px"
												th:text="${listItem[7]}"></td>
											<td style="text-align: center; width: 50px"
												th:text="${listItem[8]}"></td>
											<td style="text-align: center; width: 50px"><input
												th:data-makename="${listItem[10]}" type="radio"
												onclick="deleteProduct(this);" /></td>


										</tr>
									</tbody>
								</table>



							</div>

							<div class=" col-sm-13 text-center">
								<div
									style="background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; height: 50px; border-bottom: 1px solid #17a2b852;">
									<button
										Style="width: 100px; background: #007bff; color: white; border-radius: .25rem;"
										type="button" id="Dashboard" onclick="contentLoad(this)">Home</button>
									<button
										Style="width: 100px; border-radius: .25rem; background: #007bff; color: white;"
										type="button" id="btnBack" onclick="back();">Back</button>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
			<!-- Menu -->
			<div class="dash-app" th:if="${formmode}==null">
				<div class="spur-card-title"
					style="font-size: 25px; background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; border-bottom: 1px solid #17a2b852;">
					<div class="spur-card-title">
						Processing
						<div class="float-right">
							<button class="btn btn-primary"
								onclick="location.href='./process?formmode=add';">Add
								New Product</button>
						</div>
					</div>
				</div>
				<br>
				<!-- Table -->
				<div class="row">
					<div class="col-lg-12">
						<div class="card ">

							<div class="container-fluid">
								<div class="row">
									<div class="col-lg-12"></div>
								</div>
								<!-- Table -->

								<div class="row">
									<div class="col-lg-12">
										<div class="card " style="margin-top: 40px">
											<form method="post" autocomplete="off" id="addStockHistory"
												th:fragment="finuserapply">
												<div class="card-header"
													style="background-color: rgba(0, 0, 0, .03); color: black; font-size: 25px; padding: 1rem 1.3rem; margin-bottom: 0; border-bottom: 1px solid #17a2b852;">
													<div class="spur-card-title">Add Process</div>
												</div>
												<br>
												<div class="row">
												
												<div class="form-group col-md-2">
<label style="margin-left: 36px; font-weight: bolder;" for="productName">Work order id:</label>
</div>
	<div class="form-group col-md-2">
    <input type="text" name="woid" id="woid" list="wolist"
           onchange="readMakelistOptions()" style="width: 100%;">
    <datalist id="wolist">
        <option th:each="woList : ${woList}" 
                th:value="${woList.workId}" 
                th:text="${woList.workId}"></option>
    </datalist>
</div>
												
												
													<div class="form-group col-md-2">
														<label style="margin-left: 36px; font-weight: bolder;"
															for="productName">Select Product:</label>
													</div>
													<div class="form-group col-md-2">
    <input type="text" name="makesname[]" id="makesname" list="makelist"
           onchange="makelist_fn()" style="width: 100%;" readonly>
    <datalist id="makelist">
        <option th:each="operator : ${makelist}" 
                th:value="${operator}" 
                th:text="${operator}"></option>
    </datalist>
</div>



												</div>

												<div class="card-body" style="padding: 10px;">
													<table id="dynamicFieldsTable" class="table table-bordered">
														<thead>
															<tr>
																<th>Product Name</th>
																<th>Batch</th>
																<th>Units</th>
																<th>Category Name</th>
																<th>kgs</th>
																<th>Quantity</th>
																<th>Actions</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td><input type="text" name="product_name[]"
																	id="product_name1" list="pronameList"
																	onchange="product_name_typeFunction1(this)"
																	style="width: 100%;"readonly> <datalist
																		id="pronameList">
																		<option th:each="operator : ${productList}"
																			th:value="${operator.PRODUCT_NAME}"
																			th:text="${operator.PRODUCT_NAME}"></option>
																	</datalist></td>
																<td style="width: 110px;"><select id="BATCH"
																	onchange="getcurrentstock(this)" name="batch[]"
																	style="width: 100%;">
																		<option>SELECT</option>
																</select></td>
																<td><input type="text" name="UNITS[]" id="UNITS"
																	style="width: 100%;" readonly></td>
																<td><input type="text" name="category_name1[]"
																	id="category_name1" style="width: 100%;"></td>
																<td><input type="text" name="PKG[]" id="PKG"
																	style="width: 100%;"></td>
																	<td><input type="text" name="qty[]" id="qty"
																	style="width: 100%;"></td>
																<td><button type="button"
																		class="btn btn-success add-btn">Add</button></td>
															</tr>
														</tbody>
													</table>
													
													<table id="dynamicFieldsTableex"
														class="table table-bordered">
														<thead>
															<tr>
																<th>Expenses Type</th>
																<th>Expenses cost</th>
																<th>Actions</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td><input type="text" name="ExpensesType[]"
																	id="ExpensesType" list="Expenseslist"
																	style="width: 100%;"> <datalist
																		id="Expenseslist">
																		<option>Labour cost</option>
																		<option>Machinary cost</option>
																		<option>Electricity cost</option>
																		<option>Overhead cost</option>
																	</datalist></td>
																

																<td><input type="text" name="per/Amount[]"
																	id="per/Amount" style="width: 100%;" ></td>

																<td style="text-align:center" ><button type="button"
																		class="btn btn-success add-btnn">Add</button></td>
															</tr>
														</tbody>
													</table>
													
													
													<div class="form-row align-items-center">
														<div class="form-group col-md-2">
															<label style="font-weight: bolder;" for="productName">Mfg
																Product Name:</label>
														</div>
														<div class="form-group col-md-2">
															<input type="text" class="form-control"
																id="makingproductName" placeholder="Enter product name"
																style="border-color: #333333;" required>
														</div>
														<div class="form-group col-md-1">
															<label style="font-weight: bolder;" for="productName">order No's:</label>
														</div>
														<div class="form-group col-md-2">
															<input type="text" class="form-control" id="kilograms"
																placeholder="Enter Qty" style="border-color: #333333;"
																required>
														</div>
														<div class="form-group col-md-1"></div>
														<div class="form-group col-md-2">
															<button class="btn btn-primary" id="btnSubmit"
																style="background-color: #007bff"
																onclick="addTaxData(event);">Add Process</button>
														</div>
													</div>

												</div>








												<!-- 	<div class="card-body" style="padding: 10px;">
													<table id="dynamicFieldsTable" class="table table-bordered">
														<thead>
															<tr>
																<th>Product Name</th>
																<th>Batch</th>
																<th>GSTIN</th>
																<th>Expiry Date</th>
																<th>MRP</th>
																<th>Units in Kgs</th>
																<th>Category Name</th>
																<th>Qty</th>
																<th>Actions</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td><input type="text" name="product_name[]"
																	id="product_name1" list="pronameList"
																	onchange="product_name_typeFunction1(this)"
																	style="width: 100%;"> <datalist
																		id="pronameList">
																		<option th:each="operator : ${productList}"
																			th:value="${operator.PRODUCT_NAME}"
																			th:text="${operator.PRODUCT_NAME}"></option>
																	</datalist></td>
																<td style="width: 110px;"><select id="BATCH"
																	onchange="getcurrentstock(this)" name="batch[]"
																	style="width: 100%;">
																		<option>SELECT</option>
																</select></td>
																<td><input type="text" name="GSTIN[]" id="GSTIN"
																	style="width: 100%;"></td>
																<td><input type="text" name="EXPIRY_DATEs[]"
																	id="EXPIRY_DATEs" style="width: 100%;"></td>
																<td><input type="text" name="MRP[]" id="MRP"
																	style="width: 100%;"></td>
																<td><input type="text" name="UNITS[]" id="UNITS"
																	style="width: 100%;"></td>
																<td><input type="text" name="category_name1[]"
																	id="category_name1" style="width: 100%;"></td>
																<td><input type="text" name="PKG[]" id="PKG"
																	style="width: 100%;"></td>
																<td><button type="button"
																		class="btn btn-success add-btn">Add</button></td>
															</tr>
														</tbody>
													</table>
													<div class="form-row align-items-center">
														<div class="form-group col-md-2">
															<label style="font-weight: bolder;" for="productName">Mfg Product Name:</label>
														</div>
														<div class="form-group col-md-2">
															<input type="text" class="form-control"
																id="makingproductName" placeholder="Enter product name"
																style="border-color: #333333;" required>
														</div>
														<div class="form-group col-md-2"></div>
														<div class="form-group col-md-1">
															<button class="btn btn-primary" id="btnSubmit"
																style="background-color: #007bff"
																onclick="addTaxData(event);">Add</button>
														</div>
													</div>

												</div> -->
											</form>
										</div>
									</div>
								</div>


							</div>
							<br>
							<div class="col-lg-12  "
								style="font-size: 25px; background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; height: 50px; border-bottom: 1px solid #17a2b852;">
								<div>Process History List</div>
							</div>
							<div class="card-body">
								<table class="table table-striped " id="dataTables">
									<thead class="stats-secondary">
										<tr>
											<th style="text-align: center; font-size: 15px">REF.No.</th>
											<th style="text-align: center; font-size: 15px">Product
												Name</th>
											<th style="text-align: center; font-size: 15px">Batch</th>
											<th style="text-align: center; font-size: 15px">Category</th>
											<th style="text-align: center; font-size: 15px">Order No's</th>
											<th style="text-align: center; font-size: 15px">Make</th>
											<th style="text-align: center; font-size: 15px">Status</th>

										</tr>
									</thead>
									<tbody>
										<tr th:each="listItem : ${stockLists}" class="userlist">
											<td style="text-align: center; width: 50px"
												th:text="${listItem[10]}"></td>
											<td style="text-align: center; width: 150px"
												th:text="${listItem[1]}"></td>
											<td style="text-align: center; width: 50px"
												th:text="${listItem[2]}"></td>
											
											<td style="text-align: center; width: 100px"
												th:text="${listItem[7]}"></td>
											<td style="text-align: center; width: 50px"
												th:text="${listItem[12]}"></td>
											<td style="text-align: center; width: 150px"
												th:text="${listItem[11]}"></td>
											<td style="text-align: center; width: 100px"
												th:text="${listItem[9]}"></td>

										</tr>
									</tbody>
								</table>



							</div>

							<div class=" col-sm-13 text-center">
								<div
									style="background-color: rgba(0, 0, 0, .03); color: black; padding: 1rem 1.3rem; margin-bottom: 0; height: 50px; border-bottom: 1px solid #17a2b852;">
									<button
										Style="width: 100px; background: #007bff; color: white; border-radius: .25rem;"
										type="button" id="Dashboard" onclick="contentLoad(this)">Home</button>
									<button
										Style="width: 100px; border-radius: .25rem; background: #007bff; color: white;"
										type="button" id="btnBack" onclick="back();">Back</button>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>



</body>

</html>